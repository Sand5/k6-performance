name: K6 Performance Tests (Docker)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: k6-tests
  cancel-in-progress: true

jobs:
  smoke-tests:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - environment: local
            mock_service: mock-local
            mock_port: 3000
          - environment: qa
            mock_service: mock-qa
            mock_port: 4000
          - environment: prod
            mock_service: mock-prod
            mock_port: 5000

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t k6-tests .

      - name: Start mock API service
        env:
          MOCK_SERVICE: ${{ matrix.mock_service }}
          MOCK_PORT: ${{ matrix.mock_port }}
        run: |
          echo "Starting $MOCK_SERVICE on port $MOCK_PORT"
          docker compose up -d $MOCK_SERVICE

      - name: Wait for mock service
        env:
          MOCK_SERVICE: ${{ matrix.mock_service }}
          MOCK_PORT: ${{ matrix.mock_port }}
        run: |
          npx --yes wait-on http://$MOCK_SERVICE:$MOCK_PORT

      - name: Run k6 smoke test
        env:
          ENV_NAME: ${{ matrix.environment }}
        run: |
          docker compose run --rm \
            -e ENV=$ENV_NAME \
            -e DOCKER=true \
            k6 npm run k6:smoke

      - name: Tear down services
        if: always()
        run: docker compose down --volumes --remove-orphans

      - name: Upload k6 HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-smoke-report-${{ matrix.environment }}
          path: k6-tests/reports/smoke-report.html