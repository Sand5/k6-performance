jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - environment: local
            mock_service: mock-local
            mock_port: 3000
          - environment: qa
            mock_service: mock-qa
            mock_port: 4000
          - environment: prod
            mock_service: mock-prod
            mock_port: 5000

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t k6-tests .

      - name: Set environment variables
        run: |
          echo "ENV_NAME=${{ matrix.environment }}" >> $GITHUB_ENV
          echo "MOCK_SERVICE=${{ matrix.mock_service }}" >> $GITHUB_ENV
          echo "MOCK_PORT=${{ matrix.mock_port }}" >> $GITHUB_ENV

      - name: Start mock API service
        run: |
          echo "Starting mock API service: $MOCK_SERVICE on port $MOCK_PORT"
          # Use a unique project name per job to isolate Compose networks
          docker compose -p $ENV_NAME up -d "$MOCK_SERVICE"

      - name: Wait for mock service
        run: npx --yes wait-on "http://localhost:$MOCK_PORT"

      - name: Run k6 smoke test
        run: |
          docker compose -p $ENV_NAME run --rm \
            -e ENV="$ENV_NAME" \
            -e DOCKER=true \
            k6 npm run k6:smoke

      - name: Tear down services
        if: always()
        run: docker compose -p $ENV_NAME down --volumes --remove-orphans