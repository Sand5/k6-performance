name: K6 Performance Tests (Docker)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke-tests:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - environment: local
            mock_service: mock-local
            mock_port: 3000
          - environment: qa
            mock_service: mock-qa
            mock_port: 4000
          - environment: prod
            mock_service: mock-prod
            mock_port: 5000

    concurrency:
      # Unique group per environment to avoid cancellations
      group: k6-tests-${{ github.ref_name }}-${{ matrix.environment }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image per environment
        run: |
          docker build -t k6-tests:${{ matrix.environment }} .

      - name: Set environment variables
        run: |
          echo "ENV_NAME=${{ matrix.environment }}" >> $GITHUB_ENV
          echo "MOCK_SERVICE=${{ matrix.mock_service }}" >> $GITHUB_ENV
          echo "MOCK_PORT=${{ matrix.mock_port }}" >> $GITHUB_ENV

      - name: Start mock API service
        run: |
          echo "Starting mock API service $MOCK_SERVICE on port $MOCK_PORT"
          # Use a unique Compose project name to avoid conflicts
          docker compose -p k6-${{ matrix.environment }} up -d "$MOCK_SERVICE"

      - name: Wait for mock service
        run: |
          echo "Waiting for mock service $MOCK_SERVICE at port $MOCK_PORT..."
          npx --yes wait-on http://$MOCK_SERVICE:$MOCK_PORT

      - name: Run k6 smoke test
        run: |
          echo "Running k6 smoke test against $ENV_NAME..."
          docker compose -p k6-${{ matrix.environment }} run --rm \
            -e ENV="$ENV_NAME" \
            -e DOCKER=true \
            k6 npm run k6:smoke

      - name: Tear down services
        if: always()
        run: docker compose -p k6-${{ matrix.environment }} down --volumes --remove-orphans

      - name: Upload k6 HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-smoke-report-$ENV_NAME
          path: k6-tests/reports/smoke-report.html